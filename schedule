#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.dirname(__FILE__))

require 'beats1'
require 'rufus-scheduler'

scheduler = Rufus::Scheduler.new
tweeter = Beats1::Tweet.new
database = nil

if url = ENV["DB_URL"]
  require 'sequel'

  database = Sequel.connect(url)
  database.create_table? :played_tracks do |t|
    primary_key :id
    String  :title
    String  :artist
    Time    :played_at
    String  :last_known_show
    Bignum  :itunes_id
    String  :genre
  end

  require 'beats1/played_track'
end


scheduler.every '15s', overlap: false do
  begin
    data = tweeter.tweet
    if data[:updated]
      STDOUT.puts data.inspect
      if database
        PlayedTrack.create title: data[:title], artist: data[:artist], played_at: Time.now,
          last_known_show: data[:last_known_show], itunes_id: data[:itunes_id], genre: data[:genre]
      end
    end
  rescue Beats1::Tweet::Error => e
    STDERR.puts "Error: #{e.inspect}"
  end
end

scheduler.every '10s', overlap: false do
  tweeter.refresh_current_program
end

scheduler.join